#!/usr/bin/env php
<?php

use Colors\Color;
use GuzzleHttp\Client;
use Wulkanowy\Checker;
use Wulkanowy\AndroidXmlGenerator;
use Wulkanowy\Extractor;
use Wulkanowy\Parser;
use Wulkanowy\SimpleListGenerator;

define('ROOT_DIR', dirname(__DIR__));

include ROOT_DIR.'/vendor/autoload.php';

try {
    $c = new Color();
	echo $c('Rozpakowywanie...')->fg('green');
	$zip = glob(ROOT_DIR.'/*.zip');
	$extractor = new Extractor(end($zip));
	$extractor->extract(ROOT_DIR.'/tmp');
	echo ' zakończone.'.PHP_EOL;

	echo $c('Parsowanie...')->fg('green');
	$xml = glob(ROOT_DIR.'/tmp/*.xml');
	$parser = new Parser(end($xml));
	$counties = $parser->parse();
	echo ' zakończone.'.PHP_EOL;

	echo $c('Utworzono listę '.count($counties).' elementów.')->fg('green').PHP_EOL;

	echo $c('Testowanie...')->fg('green');
	$checker = new Checker($counties, new Client(['base_uri' => 'https://uonetplus.vulcan.net.pl/']));
	$filteredCounties = $checker->getUp();
	echo $c('Odnaleziono '.count($filteredCounties).' z '.count($counties))->fg('yellow').PHP_EOL;
	echo $c('Testowanie zakończone.')->fg('green').PHP_EOL;

	echo $c('Generowanie pliku...')->fg('green');
	$xmlGenerator = new AndroidXmlGenerator($filteredCounties);
	$xmlGenerator->save(ROOT_DIR.'/generated_counties.xml');
	$textGenerator = new SimpleListGenerator($filteredCounties);
	$textGenerator->save(ROOT_DIR.'/symbols.txt');
	echo ' zakończone.'.PHP_EOL;
	echo $c('Zapisano do pliku `generated_counties.xml` i symbols.txt.')->fg('green').PHP_EOL;

} catch (Throwable $e) {
	echo PHP_EOL;
	echo $c('ERROR: '.$e)->fg('red');
	echo PHP_EOL;
}
